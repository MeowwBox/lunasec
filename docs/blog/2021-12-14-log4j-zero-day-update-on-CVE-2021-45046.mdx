---
title: "Log4Shell Update: Second log4j Vulnerability Published (CVE-2021-44228 + CVE-2021-45046)" 
description: A quick update on the situation now that a new log4j CVE has been created and patched in 2.16.0. We've done research and these are our findings.
slug: log4j-zero-day-update-on-cve-2021-45046
date: 2021-12-14
image: https://www.lunasec.io/docs/img/log4shell-logo.png
keywords: [log4shell, log4j, log4j2, rce, java, zero-day, mitigation]
authors:
- name: Free Wortley
  title: CEO at LunaSec
  url: https://github.com/freeqaz
  image_url: https://github.com/freeqaz.png
  tags: [zero-day, security, data-security, data-breaches, guides]
- name: Chris Thompson
  title: Developer at Lunasec
  url: https://github.com/breadchris
  image_url: https://github.com/breadchris.png
- name: Forrest Allison
  title: Developer at LunaSec
  url: https://github.com/factoidforrest
  image_url: https://github.com/factoidforrest.png

---
<!--
  ~ Copyright by LunaSec (owned by Refinery Labs, Inc)
  ~
  ~ Licensed under the Creative Commons Attribution-ShareAlike 4.0 International
  ~ (the "License"); you may not use this file except in compliance with the
  ~ License. You may obtain a copy of the License at
  ~
  ~ https://creativecommons.org/licenses/by-sa/4.0/legalcode
  ~
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  ~
-->

![Log4Shell Logo](https://www.lunasec.io/docs/img/log4shell-logo.png)

After the Log4j maintainers released version 2.15.0 to address the Log4Shell vulnerability, an additional attack vector
was identified and reported in [CVE-2021-45046](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046). If you had
previously upgraded your Log4j dependency to `2.15.0`, you are still vulnerable to a denial of service (DOS) attack under
certain conditions:

> It was found that the fix to address CVE-2021-44228 in Apache Log4j 2.15.0 was incomplete in certain non-default configurations.

We found this report concerning as it states that one of the recommended temporary mitigations for versions `2.10.0 <= Apache log4j <= 2.14.0`
did not protect against this CVE:

> Note that previous mitigations involving configuration such as to set the system property `log4j2.noFormatMsgLookup` to `true` do NOT mitigate this specific vulnerability.

It was not readily apparently from reading this CVE what specifically was affected, or how this vulnerability is actually
triggered.

Fortunately the community has been hard at work reacting to these updates. A fork of [christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) [added some
changes](https://github.com/kmindi/log4shell-vulnerable-app/commit/e539f7e9a0c81e2c580d63caff5f4eae14033f19) to demonstrate
the specific scenario in which this newly found CVE could affect an application.

In these changes, the previously discovered mitigation was included:

```bash
# Add environment variable as the currently official workaround for vulnerable versions of log4j2 (e.g. 2.14.1)
ENV LOG4J_FORMAT_MSG_NO_LOOKUPS true
```

As well as updating the Log4j2 properties config:

```bash
# ...
# vulnerable in 2.14.1 even with ENV LOG4J_FORMAT_MSG_NO_LOOKUPS true
appender.console.layout.pattern = ${ctx:apiversion} - %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m%n
# ...
```

And updating the vulnerable code location from directly logging the attacker controlled input:

```ts
@GetMapping("/")
public String index(@RequestHeader("X-Api-Version") String apiVersion) {
    logger.info("Received a request for API version " + apiVersion);
    return "Hello, world!";
}
```

To putting the attacker controlled input into a `ThreadContext` value:

```ts
@GetMapping("/")
public String index(@RequestHeader("X-Api-Version") String apiVersion) {

    // Add user controlled input to threadcontext;
    // Used in log via ${ctx:apiversion}
    ThreadContext.put("apiversion", apiVersion);

    // Notice how these changes remove apiVersion from directly being logged
    logger.info("Received a request for API version");
    return "Hello, world!";
}
```

:::info Vulnerable App Log4j version

This vulnerable application was running with Log4j version `2.14.1` which is still vulnerable to the RCE even
_before_ the `LOG4J_FORMAT_MSG_NO_LOOKUPS` mitigation.

:::

Running this vulnerable server and exploiting the vulnerability with our [log4shell cli tool](https://github.com/lunasec-io/lunasec/tree/master/tools/log4shell)
we observed that RCE was still possible in versions `2.10.0 <= Apache log4j < 2.15.0`:

[![Log4j RCE on log4j 2.14.1 with mitigation](/img/log4shell-CVE-2021-45046-exploitation-with-mitigation.png)](/img/log4shell-CVE-2021-45046-exploitation-with-mitigation.png)

The server is still vulnerable even with `LOG4J_FORMAT_MSG_NO_LOOKUPS` enabled because the Pattern Layout has been modified
to include a reference to a Thread Context value. It appears that referencing Thread Context values in this way bypasses
the logic for disabling JNDI lookups when formatting a message. The [CVE report](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45046)
outlines this as well the other types of formatting types:

> This could allows attackers with control over Thread Context Map (MDC) input data when the logging configuration uses
a non-default Pattern Layout with either a Context Lookup (for example, $${ctx:loginId}) or a Thread Context Map pattern
(%X, %mdc, or %MDC) to craft malicious input data using a JNDI Lookup pattern.

We were not able to achieve RCE when using `%X, %mdc, or %MDC`, however we still do not consider these as safe to include
when running a Log4j version `< 2.16.0`. To understand more about the Log4j Thread Context map, please refer to the [docs](https://logging.apache.org/log4j/2.x/manual/thread-context.html).

If you have previously used `LOG4J_FORMAT_MSG_NO_LOOKUPS` to mitigate the log4shell vulnerability, in certain conditions
this will not be sufficient to protect your code from RCE. Refer to our [mitigation guide](https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide)
for additional steps you can take to remediate the impact of Log4Shell.

The less impactful part of this CVE, if you have updated your Log4j version to `2.15.0`, is that there is a denial of service (DOS)
which is possible:

[![Log4j DOS on log4j 2.15.0 with mitigation](/img/log4shell-CVE-2021-45046-dos-with-mitigation.png)](/img/log4shell-CVE-2021-45046-dos-with-mitigation.png)

However, in our testing we did not find this DOS to be resource consuming as it seemed that the infinite loop created by recursively
resolving `${ctx:apiVersion}` was identified by the program and errored out.

Log4j `2.16.0` completely mitigates this issue by `removing support for message lookup patterns and disabling JNDI functionality by default`.

We continue to recommend _not_ using `%m{nolookups}`, which we outline in our [mitigation guide](https://www.lunasec.io/docs/blog/log4j-zero-day-mitigation-guide), as we have also
proved the vulnerability is still exploitable with a Pattern Layout such as:

```
appender.console.layout.pattern = ${ctx:apiversion} - %d{yyyy-MM-dd HH:mm:ss} %-5p %c{1}:%L - %m{nolookups}%n
```

`%m{nolookups` will only apply to the content being logged in the call to `logger.info()` and will not apply to the
resolving of `${ctx:apiversion}` which will contain our payload.

import ContactForm from '../src/components/ContactForm.jsx'

<ContactForm/>

